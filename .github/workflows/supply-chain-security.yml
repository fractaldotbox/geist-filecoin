name: Supply Chain Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  attestations: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "23"
  PNPM_VERSION: "10.13.1"

jobs:
  provenance:
    name: Generate Build Provenance
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4


      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build with provenance
        run: |
          echo "Building with provenance tracking..."
          pnpm run build
          
          # Generate build metadata
          cat > build-metadata.json << EOF
          {
            "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
            "commitSha": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "actor": "${{ github.actor }}",
            "workflow": "${{ github.workflow }}",
            "runId": "${{ github.run_id }}",
            "nodeVersion": "${{ env.NODE_VERSION }}",
            "pnpmVersion": "${{ env.PNPM_VERSION }}"
          }
          EOF

      - name: Generate attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: |
            apps/webapp/dist/**
            packages/*/dist/**
            build-metadata.json

  dependency-review:
    name: Dependency Review
    permissions:
      contents: read
      pull-requests: write
      issues: write
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-3-Clause, ISC
          comment-summary-in-pr: always